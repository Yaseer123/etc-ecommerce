version: 1

frontend:
  phases:
    preBuild:
      commands:
        - npm install -g pnpm
        - export NODE_OPTIONS="--max-old-space-size=4096"
        - pnpm install
        - pnpm approve-builds @parcel/watcher @prisma/client @prisma/engines @sentry/cli prisma sharp
        - npx prisma generate
    build:
      commands:
        - pnpm run build
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - .next/cache/**/*
      - node_modules/**/*

backend:
  phases:
    preBuild:
      commands:
        - npm install -g pnpm
        - pnpm install
        - pnpm approve-builds @parcel/watcher @prisma/client @prisma/engines @sentry/cli prisma sharp
        - npx prisma generate
        - npx prisma migrate deploy
    build:
      commands:
        - pnpm run build
  artifacts:
    baseDirectory: .
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
